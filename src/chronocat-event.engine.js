"use strict";var U=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var z=(e,a)=>{for(var n in a)U(e,n,{get:a[n],enumerable:!0})},F=(e,a,n,o)=>{if(a&&typeof a=="object"||typeof a=="function")for(let r of W(a))!K.call(e,r)&&r!==n&&U(e,r,{get:()=>a[r],enumerable:!(o=J(a,r))||o.enumerable});return e};var H=e=>F(U({},"__esModule",{value:!0}),e);var se={};z(se,{apply:()=>ae,name:()=>j,version:()=>oe});module.exports=H(se);var f=require("electron"),O=e=>{let a=async t=>{if(!e.filter){e.handler(t);return}await e.filter(t)&&e.handler(t)},n=Symbol(),o=0,r=f.ipcMain.emit.bind(f.ipcMain);f.ipcMain.emit=function(t,i,...c){let m=i.sender;if(!m[n]){m[n]=!0;let I=m.send.bind(m);m.send=function(g,...y){I.call(this,g,...y);let N=e.getId?.(y);a(N?{type:"wrapped-response",channel:g,method:e.getMethod?.(y),args:y,id:N}:{type:"event",channel:g,method:e.getMethod?.(y),args:y})}}r.call(this,t,i,...c);let h=e.getId?.(c);return a(h?{type:"wrapped-request",channel:t,method:e.getMethod?.(c),args:c,id:h}:{type:"request",channel:t,method:e.getMethod?.(c),args:c}),!1};let s=f.ipcMain.handle.bind(f.ipcMain);return f.ipcMain.handle=function(t,i){let c=async(m,...h)=>{let I=`IPCMAN_HANDLE_${o++}`;a({type:"handle-request",channel:t,method:e.getMethod?.(h),args:h,id:I});let g=await Promise.resolve(i(m,...h));return a({type:"handle-response",channel:t,method:e.getMethod?.(h),args:[g],id:I}),g};s.call(this,t,c)},{emit:r,senderExcludeSymbol:n}};var u;(function(e){e[e.Private=1]="Private",e[e.Group=2]="Group",e[e.Guild=4]="Guild",e[e.MsgBox=7]="MsgBox"})(u||(u={}));var d;(function(e){e[e.Value1=1]="Value1",e[e.Normal=2]="Normal",e[e.Value3=3]="Value3",e[e.System=5]="System",e[e.Ptt=6]="Ptt",e[e.Video=7]="Video",e[e.Value8=8]="Value8",e[e.WithRecords=9]="WithRecords",e[e.Wallet=10]="Wallet",e[e.Ark=11]="Ark",e[e.Vaule17=17]="Vaule17"})(d||(d={}));var l;(function(e){e[e.Normal=0]="Normal",e[e.System=3]="System"})(l||(l={}));var p;(function(e){e[e.Normal1=1]="Normal1",e[e.Normal2=2]="Normal2",e[e.Super=3]="Super",e[e.MarketEmoticon=4]="MarketEmoticon",e[e.PCPoke=5]="PCPoke"})(p||(p={}));var q;(function(e){e[e.Liulian=9]="Liulian",e[e.LveLveLve=10]="LveLveLve",e[e.Pingdiguo=11]="Pingdiguo",e[e.Chaopiao=12]="Chaopiao"})(q||(q={}));var E;(function(e){e[e.None=0]="None",e[e.All=1]="All",e[e.Normal=2]="Normal"})(E||(E={}));var P;(function(e){e[e.Value0=0]="Value0",e[e.Value1=1]="Value1"})(P||(P={}));var _;(function(e){e[e.Value0=0]="Value0",e[e.Value1=1]="Value1",e[e.Value2=2]="Value2"})(_||(_={}));var $;(function(e){e[e.Normal=1]="Normal",e[e.MsgBox=2]="MsgBox",e[e.Value14=14]="Value14"})($||($={}));var T={},w=[],b=[],S={},x={};var C=require("node:buffer");var G=e=>({chatType:e.chatType,msgType:e.msgType,subMsgType:{text:!!(e.subMsgType&1),pic:!!(e.subMsgType&2),face:!!(e.subMsgType&16),link:!!(e.subMsgType&128),multiForward:!!(e.subMsgType&8),reply:e.msgType===d.WithRecords&&!!(e.subMsgType&32),marketFace:e.msgType==d.Vaule17&&!!(e.subMsgType&8),file:e.msgType===d.Value3&&!!(e.subMsgType&512)},sendType:e.sendType});var M=(e,a)=>n=>Q(e,a,n),Q=async(e,a,n)=>{let o=e.chronocat.l,r=await X(e,a,n);if(!r)return;let s=[];for(let t of r){if(!t.message?.id&&!t.user?.id){o.warn("satori: parser: \u4E22\u5F03\u4E86\u4E00\u6761\u6D88\u606F",{code:2127});continue}else t.message?.id?t.user?.id?!t.user?.name&&!t.member?.nick&&o.warn(`satori: parser: \u6D88\u606F ${t.message.id} \u4E0D\u5E26\u6709 userName\uFF0C\u8BF7\u6CE8\u610F\u3002`,{code:2130}):o.warn(`satori: parser: \u6D88\u606F ${t.message.id} \u4E0D\u5E26\u6709 userId\uFF0C\u8BF7\u6CE8\u610F\u3002`,{code:2129}):o.warn(`satori: parser: \u6765\u81EA ${t.user?.name} (${t.user?.id}) \u7684\u6D88\u606F\u4E0D\u5E26\u6709 messageId\uFF0C\u8BF7\u6CE8\u610F\u3002`,{code:2128});s.push(t)}return s},X=async(e,a,n)=>{let o={id:void 0,type:void 0,platform:void 0,self_id:void 0,timestamp:Number(n.msgTime)*1e3};o.user={id:n.senderUin,name:n.sendNickName||void 0,avatar:`http://thirdqq.qlogo.cn/headimg_dl?dst_uin=${n.senderUin}&spec=640`};let r=G(n);switch(o.channel={},r.chatType){case u.Private:o.channel.type=1,o.channel.id=`private:${n.peerUin}`,o.channel.name=n.peerName;break;case u.Group:o.guild={},o.member={},n.sendMemberName&&(o.member.nick=n.sendMemberName),o.channel.type=0,o.channel.id=o.guild.id=n.peerUid,o.channel.name=o.guild.name=S[n.peerUid].groupName,o.guild.avatar=`https://p.qlogo.cn/gh/${n.peerUid}/${n.peerUid}/640`;break}if(!(r.msgType===d.Ark&&n.subMsgType===0&&r.sendType===l.Normal)){if(r.msgType===d.Normal||r.msgType===d.Value3||r.msgType===d.Ptt||r.msgType===d.Video||r.msgType===d.WithRecords||r.msgType===d.Vaule17)return k(e,a,o,n).then(s=>[s[0],...s[1]]);if(r.msgType===d.System&&n.subMsgType===8&&r.sendType===l.System&&n.elements[0].elementType===8&&n.elements[0].grayTipElement.subElementType===4&&n.elements[0].grayTipElement.groupElement.type===1)return await Y(e,a,o,n);if(r.msgType===d.System&&n.subMsgType===8&&r.sendType===l.System&&n.elements[0].elementType===8&&n.elements[0].grayTipElement.subElementType===4&&n.elements[0].grayTipElement.groupElement.type===8)return await Z(e,a,o,n);if(r.msgType===d.System&&n.subMsgType===8&&r.sendType===l.System&&n.elements[0].elementType===8&&n.elements[0].grayTipElement.subElementType===4&&n.elements[0].grayTipElement.groupElement.type===5)return;if(r.msgType===d.System&&n.subMsgType===12&&r.sendType===l.System&&n.elements[0].elementType===8&&n.elements[0].grayTipElement.subElementType===12&&n.elements[0].grayTipElement.xmlElement.busiType==="1"&&n.elements[0].grayTipElement.xmlElement.busiId==="10145")return await te(e,a,o,n);if(r.msgType===d.System&&n.subMsgType===17&&r.sendType===l.System)return;if(r.msgType===d.System&&n.subMsgType===12&&r.sendType===l.System&&n.elements[0].elementType===8&&n.elements[0].grayTipElement.subElementType===17&&n.elements[0].grayTipElement.jsonGrayTipElement.busiId==="1061")return await ne(e,a,o,n)}};async function k(e,a,n,o){let[r,s]=await V(e,a,o);return n.type="message-created",n.message={id:o.msgId,content:r.join("")},[n,s]}async function Y(e,a,n,o){let[r,s]=await k(e,a,n,o);return r.type="guild-member-added",r.operator={id:o.elements[0].grayTipElement.groupElement.adminUin,name:void 0},r.user={id:o.elements[0].grayTipElement.groupElement.memberUin,name:o.elements[0].grayTipElement.groupElement.memberNick,avatar:`http://thirdqq.qlogo.cn/headimg_dl?dst_uin=${o.elements[0].grayTipElement.groupElement.memberUin}&spec=640`},r.member||(r.member={}),[r,...s]}async function Z(e,a,n,o){let[r,s]=await k(e,a,n,o);return Number(o.elements[0].grayTipElement.groupElement.shutUp.duration)?r.type="unsafe-guild-mute":r.type="unsafe-guild-unmute",r.operator={id:o.elements[0].grayTipElement.groupElement.shutUp.admin.uin,name:void 0},r.user={id:o.elements[0].grayTipElement.groupElement.shutUp.member.uin,name:o.elements[0].grayTipElement.groupElement.shutUp.member.name,avatar:`http://thirdqq.qlogo.cn/headimg_dl?dst_uin=${o.elements[0].grayTipElement.groupElement.shutUp.member.uin}&spec=640`},r.member&&delete r.member,[r,...s]}var ee=/jp="(\d+)".*jp="(\d+)"/gim;async function te(e,a,n,o){let[r,s]=await k(e,a,n,o);r.type="guild-member-added";let t=ee.exec(o.elements[0].grayTipElement.xmlElement.content);if(!Array.isArray(t)||t.length<3)return;let[i,c,m]=t;return r.operator={id:c,name:void 0},r.user={id:m,name:void 0,avatar:`http://thirdqq.qlogo.cn/headimg_dl?dst_uin=${m}&spec=640`},r.member||(r.member={}),[r,...s]}async function ne(e,a,n,o){let r=JSON.parse(o.elements[0].grayTipElement.jsonGrayTipElement.jsonStr),[s,t]=r.items.filter(i=>i.type=="qq");return n.type="message-created",n.message={id:o.msgId,content:`<${e.chronocat.platform}:poke user-id="${e.chronocat.uix.getUin(t.uid)}" operator-id="${e.chronocat.uix.getUin(s.uid)}"/>`},[n]}async function V(e,a,n){let o=e.chronocat.l,r=[],s=[];for(let t of n.elements)switch(t.elementType){case 1:{switch(t.textElement.atType){case E.None:{r.push(e.chronocat.h.text(t.textElement.content.replaceAll(`\r
`,`
`).replaceAll("\r",`
`)));break}case E.Normal:{e.chronocat.uix.add(t.textElement.atNtUid,t.textElement.atUid);let i=t.textElement.atUid;i==="0"&&(i=void 0),i||=e.chronocat.uix.getUin(t.textElement.atNtUid);let c=t.textElement.content.slice(1);if(!i){o.warn(`satori: parser: at \u76EE\u6807 ${c} \u4E0D\u5E26\u6709 id\uFF0C\u5C06\u8DF3\u8FC7\u8BE5\u5143\u7D20\u3002`,{code:2131});break}r.push(e.chronocat.h("at",{id:i,name:c}));break}}break}case 2:{r.push(e.chronocat.h("img",{src:`${a.self_url}/v1/assets/${C.Buffer.from(JSON.stringify({type:"mediav1",msgId:n.msgId,chatType:n.chatType,peerUid:n.peerUid,elementId:t.elementId,thumbSize:t.picElement.thumbFileSize})).toString("base64url")}`}));break}case 3:{r.push(e.chronocat.h("file",{src:`${a.self_url}/v1/assets/${C.Buffer.from(JSON.stringify({type:"mediav1",msgId:n.msgId,chatType:n.chatType,peerUid:n.peerUid,elementId:t.elementId,thumbSize:t.fileElement.thumbFileSize})).toString("base64url")}`}));break}case 4:{r.push(e.chronocat.h("audio",{src:`${a.self_url}/v1/assets/${C.Buffer.from(JSON.stringify({type:"mediav1",msgId:n.msgId,chatType:n.chatType,peerUid:n.peerUid,elementId:t.elementId,thumbSize:0})).toString("base64url")}`}));break}case 5:{r.push(e.chronocat.h("video",{src:`${a.self_url}/v1/assets/${C.Buffer.from(JSON.stringify({type:"mediav1",msgId:n.msgId,chatType:n.chatType,peerUid:n.peerUid,elementId:t.elementId,thumbSize:t.videoElement.thumbSize})).toString("base64url")}`}));break}case 6:{switch(t.faceElement.faceType){case p.PCPoke:{r.push(e.chronocat.h(`${e.chronocat.platform}:pcpoke`,{id:t.faceElement.pokeType}));break}case p.Normal1:case p.Normal2:case p.Super:{r.push(e.chronocat.h(`${e.chronocat.platform}:face`,{id:t.faceElement.faceIndex,name:`[${(await e.chronocat.api["chronocat.internal.qface.get"](`${t.faceElement.faceIndex}`)).QDes.slice(1)}]`,platform:e.chronocat.platform,"unsafe-super":t.faceElement.faceType===p.Super?!0:void 0,"unsafe-result-id":t.faceElement.resultId,"unsafe-chain-count":t.faceElement.chainCount}));break}case p.MarketEmoticon:{r.push(e.chronocat.h(`${e.chronocat.platform}:face`,{id:t.faceElement.faceIndex,platform:e.chronocat.platform,"unsafe-market-emoticon":!0}));break}}break}case 7:{let i=n.records.find(c=>c.msgId===t.replyElement.sourceMsgIdInRecords);r.push(e.chronocat.h("quote",{"chronocat:seq":t.replyElement.replayMsgSeq},[await re(e,i),...(await V(e,a,i))[0]]));break}case 11:{r.push(e.chronocat.h(`${e.chronocat.platform}:marketface`,{tabId:t.marketFaceElement.emojiPackageId,faceId:t.marketFaceElement.emojiId,key:t.marketFaceElement.key},[e.chronocat.h("img",{src:`${a.self_url}/v1/assets/${C.Buffer.from(JSON.stringify({type:"mfacev1",tabId:t.marketFaceElement.emojiPackageId,faceId:t.marketFaceElement.emojiId,key:t.marketFaceElement.key,name:t.marketFaceElement.faceName,filePath:t.marketFaceElement.staticFacePath})).toString("base64url")}`})]));break}case 27:{r.push(e.chronocat.h(`${e.chronocat.platform}:facebubble`,{id:t.faceBubbleElement.faceType,count:t.faceBubbleElement.faceCount,name:t.faceBubbleElement.faceSummary,content:t.faceBubbleElement.content}));break}default:break}return[r,s]}async function re(e,a){return e.chronocat.h("author",{id:a.senderUin,name:a.sendMemberName||a.sendNickName,avatar:`http://thirdqq.qlogo.cn/headimg_dl?dst_uin=${a.senderUin}&spec=640`})}var v=class{constructor(a){this.messages=a}type="satori";toSatori=async(a,n)=>(await Promise.all(this.messages.map(M(a,n)))).filter(Boolean).flat().filter(Boolean)},R=class{constructor(a){this.messages=a}type="satori";toSatori=async(a,n)=>(await Promise.all(this.messages.map(M(a,n)))).filter(Boolean).flat().filter(Boolean).map(o=>(o.type="message-deleted",o))},L=class{constructor(a,n){this.buddyReq=a;this.uin=n}type="satori";toSatori=async(a,n)=>{let o={id:void 0,type:"friend-request",platform:a.chronocat.platform,self_id:void 0,timestamp:Number(this.buddyReq.reqTime)*1e3};return o.user={id:`${this.uin}`,name:this.buddyReq.friendNick,avatar:`http://thirdqq.qlogo.cn/headimg_dl?dst_uin=${this.uin}&spec=640`},[o]}};var D=e=>a=>{switch(a.type){case"event":{if(!a.args[1]||!Array.isArray(a.args[1]))return;let n=a.args[1];if(!n.length)return;let o=n[0];if(!o||!("cmdName"in o))return;B(e,a.channel,o.cmdName,o.payload);return}case"wrapped-request":{T[a.id]=a.args[1][0];return}case"wrapped-response":{let n=T[a.id];if(!n)return;delete T[a.id],B(e,a.channel,n,a.args[1]);return}}},B=async(e,a,n,o)=>{switch(n){case"nodeIKernelMsgListener/onRecvActiveMsg":case"nodeIKernelMsgListener/onRecvMsg":{if(a!=="IPC_DOWN_2")return;let{msgList:r}=o;for(let t of r)e.chronocat.uix.add(t.senderUid,t.senderUin),t.chatType===u.Private&&e.chronocat.uix.add(t.peerUid,t.peerUin);let s=await Promise.all(r.filter(A).map(async t=>t));s.length&&e.chronocat.emit(new v(s));return}case"nodeIKernelProfileListener/onProfileSimpleChanged":case"nodeIKernelProfileListener/onProfileDetailInfoChanged":case"nodeIKernelGroupListener/onSearchMemberChange":case"nodeIKernelGroupService/getNextMemberList":{let{profiles:r,infos:s}=o,t=r??s;for(let[i,{uin:c}]of t)e.chronocat.uix.add(i,c);return}case"nodeIKernelGroupListener/onMemberInfoChange":{let{members:r}=o;for(let[s,{uin:t}]of r)e.chronocat.uix.add(s,t);return}case"nodeIKernelGroupListener/onMemberListChange":{let{info:r}=o;if(!r.sceneId.split("_")[0])return;for(let[t,{uin:i}]of r.infos)e.chronocat.uix.add(t,i);return}case"nodeIKernelRecentContactListener/onRecentContactListChangedVer2":{let{changedRecentContactLists:r}=o;for(let s of r)for(let t of s.changedList)e.chronocat.uix.add(t.senderUid,t.senderUin),t.chatType===u.Private&&e.chronocat.uix.add(t.peerUid,t.peerUin);return}case"onOpenParamChange":{let{data:r}=o;for(let s of r)e.chronocat.uix.add(s.senderUid,s.senderUin),s.chatType===u.Private&&e.chronocat.uix.add(s.peerUid,s.peerUin);return}case"nodeIKernelMsgService/getMsgsIncludeSelf":{let{msgList:r}=o;for(let s of r)e.chronocat.uix.add(s.senderUid,s.senderUin),s.chatType===u.Private&&e.chronocat.uix.add(s.peerUid,s.peerUin);return}case"onGroupListUpdate":case"nodeIKernelGroupListener/onGroupListUpdate":{let{groupList:r}=o;for(let s of r)S[s.groupCode]=s;return}case"onBuddyListChange":case"nodeIKernelBuddyListener/onBuddyListChange":{let{data:r}=o;for(let s of r)for(let t of s.buddyList)e.chronocat.uix.add(t.uid,t.uin),x[t.uin]=t;return}case"nodeIKernelBuddyListener/onBuddyReqChange":{if(a!=="IPC_DOWN_2")return;let{buddyReqs:r}=o;r.forEach(s=>{if(s.reqType!==1||s.reqSubType!==1)return;let t=e.chronocat.uix.getUin(s.friendUid);if(!t)return;let i=`${t}:${s.reqTime}`;w.includes(i)||(w.push(i),e.chronocat.emit(new L(s,t)))});return}case"nodeIKernelMsgListener/onAddSendMsg":{let{msgRecord:r}=o;b.push(r.msgId);return}case"nodeIKernelMsgListener/onMsgInfoListUpdate":{let{msgList:r}=o;for(let t of r)e.chronocat.uix.add(t.senderUid,t.senderUin),t.chatType===u.Private&&e.chronocat.uix.add(t.peerUid,t.peerUin);if(a!=="IPC_DOWN_2")return;r.filter(t=>t.sendStatus>1&&b.find(i=>t.msgId===i)).forEach(t=>{b.splice(b.indexOf(t.msgId),1),e.chronocat.emit(new v([t]))});let s=await Promise.all(r.filter(t=>t.msgType===d.System&&t.subMsgType===4&&!t.isOnlineMsg&&Number(t.recallTime)&&t.elements[0].elementType===8&&t.elements[0].grayTipElement?.subElementType===1).filter(A).map(async t=>t));s.length&&e.chronocat.emit(new R(s));return}}},A=e=>"peer"in e?!e.elements.some(a=>a.walletElement||a.arkElement):!(e.msgType===d.Ark||e.msgType===d.Wallet||e.msgType===d.System&&e.subMsgType===17&&e.sendType===l.System&&e.elements[0].elementType===8&&e.elements[0].grayTipElement.subElementType===16&&e.elements[0].grayTipElement.jsonGrayTipElement.busiId==="81");var j="engine-chronocat-event",oe="0.2.15",ae=async e=>{O({handler:D(e),getId:n=>n?.[0]?.callbackId}),e.chronocat.api.register(j)("chronocat.internal.red.message.parse",(n,o)=>M(e,o)(n)),await e.chronocat.whenReady()};0&&(module.exports={apply,name,version});
